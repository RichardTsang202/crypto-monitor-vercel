# API限制和延迟配置说明

本文档详细说明了四个数据源API的免费版限制和相应的延迟配置策略。

## 📊 API限制对比

| 数据源 | 免费版限制 | 每分钟请求数 | 每月调用数 | 延迟设置 | 备注 |
|--------|------------|--------------|------------|----------|---------|
| 币安 (Binance) | 请求权重6000/分钟 | ~1200次 | 无限制 | 50ms | 权重系统，大部分接口权重为1-5 |
| CoinGecko | 30次/分钟 | 30次 | 10,000次 | 2000ms | 需要API密钥 |
| Alpha Vantage | 5次/分钟 | 5次 | 25次/天 | 12000ms | 严格限制，适合低频使用 |
| CoinMarketCap | 30次/分钟 | 30次 | 10,000次 | 2000ms | 基础计划，11个端点 |

## ⚙️ 延迟配置策略

### 1. 币安 (Binance) - 主要数据源
- **延迟**: 50ms
- **原因**: 权重限制宽松，可以高频访问
- **策略**: 作为主要数据源，保持低延迟以获得实时数据

### 2. CoinGecko - 第一备用
- **延迟**: 2000ms (2秒)
- **原因**: 每分钟30次限制，需要合理分配
- **策略**: 适中延迟，平衡数据实时性和API限制

### 3. Alpha Vantage - 第二备用
- **延迟**: 12000ms (12秒)
- **原因**: 严格的5次/分钟限制
- **策略**: 高延迟，仅在其他数据源失效时使用

### 4. CoinMarketCap - 第三备用
- **延迟**: 2000ms (2秒)
- **原因**: 每分钟30次限制，与CoinGecko类似
- **策略**: 适中延迟，作为最后的备用数据源

## 🔄 故障转移机制

### 优先级顺序
1. **币安** → 2. **CoinGecko** → 3. **Alpha Vantage** → 4. **CoinMarketCap**

### 健康检查间隔
- **检查频率**: 每5分钟 (300秒)
- **失败阈值**: 每个数据源最多3次连续失败
- **恢复机制**: 健康检查通过后自动恢复到优先级更高的数据源

## 📈 使用建议

### 开发环境
- 建议使用币安作为主要数据源
- 配置CoinGecko API密钥作为备用
- Alpha Vantage仅用于紧急情况

### 生产环境
- 必须配置所有API密钥
- 监控API使用量，避免超出限制
- 考虑升级到付费计划以获得更高限制

## 🚨 注意事项

1. **API密钥安全**: 所有API密钥都应存储在`.env`文件中，不要提交到版本控制
2. **使用量监控**: 定期检查API使用量，避免超出免费额度
3. **错误处理**: 系统会自动处理API限制错误并切换到备用数据源
4. **数据一致性**: 不同数据源的数据格式可能略有差异，系统已做标准化处理

## 🔧 配置示例

```env
# 主要数据源 - 币安 (无需API密钥)

# 备用数据源配置
COINGECKO_API_KEY=your_coingecko_api_key_here
ALPHA_VANTAGE_API_KEY=your_alpha_vantage_api_key_here
COINMARKETCAP_API_KEY=your_coinmarketcap_api_key_here

# 数据源优先级
DATA_SOURCE_PRIORITY=BINANCE,COINGECKO,ALPHA_VANTAGE,COINMARKETCAP
```

## 📊 性能优化建议

1. **缓存机制**: 实现本地缓存减少API调用
2. **批量请求**: 尽可能使用批量接口
3. **智能切换**: 根据网络状况和API响应时间动态调整
4. **监控告警**: 设置API使用量告警机制

---

*最后更新: 2024年1月*